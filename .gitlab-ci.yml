image: docker:stable

variables:
    GIT_STRATEGY: none
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_DRIVER: overlay2
    RELEASE_IMAGE: $REGISTRY_HOST/$REGISTRY_IMAGE

services:
    - docker:18.09.7-dind

cache:
    key: "$CI_COMMIT_REF_SLUG"
    paths:
        - image/

stages:
    - Build
    - Test
    - Release
#    - Cleanup

Build and release:
    stage: Build
    script:
        - docker pull $RELEASE_IMAGE || true
        - docker build -t $RELEASE_IMAGE --cache-from $RELEASE_IMAGE .
        - docker push $RELEASE_IMAGE
    variables:
        GIT_STRATEGY: clone
    tags:
        - dind